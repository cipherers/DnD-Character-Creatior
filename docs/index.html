<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="static/css/dnd-theme.css">
    <link rel="icon" href="data:,">
    <script src="static/js/config.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>

<body class="flex items-center justify-center min-h-screen p-4 pt-24">
    <header class="absolute top-0 left-0 w-full p-4 z-50">
        <nav class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold" style="color: var(--accent-gold);">DnD Character Creator</h1>
            <ul class="flex gap-6">
                <li><a href="login.html">Login</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="add_dnd_info.html">Add Info</a></li>
                <li><a href="gamer_manual.html">Manual</a></li>
            </ul>
        </nav>
    </header>

    <div class="parchment-box p-8 md:p-12 w-full max-w-3xl">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold mb-2">Create Character</h1>
            <p class="text-sm italic" style="color: var(--border-brown);">Forging a new legend...</p>
            <div class="hr-dnd w-1/2 mx-auto"></div>
        </div>

        <div id="message-container"></div>

        <form id="character-form" class="space-y-8">
            <!-- Basic Character Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label for="name" class="block mb-1">Name</label>
                    <input type="text" id="name" name="name" class="w-full form-input-dnd" placeholder="e.g. Aragorn"
                        required>
                </div>
                <div>
                    <label for="age" class="block mb-1">Age</label>
                    <input type="number" id="age" name="age" class="w-full form-input-dnd" placeholder="25" required
                        min="1">
                </div>
                <div>
                    <label for="level" class="block mb-1">Level</label>
                    <input type="number" id="level" name="level" class="w-full form-input-dnd" value="1" required
                        min="1">
                </div>
                <div>
                    <label for="race" class="block mb-1">Race</label>
                    <select id="race" name="race" class="w-full form-input-dnd" required>
                        <option value="">-- Loading Races... --</option>
                    </select>
                </div>
                <div>
                    <label for="class" class="block mb-1">Class</label>
                    <select id="class" name="class" class="w-full form-input-dnd" required>
                        <option value="">-- Loading Classes... --</option>
                    </select>
                </div>
                <div>
                    <label for="background" class="block mb-1">Background</label>
                    <select id="background" name="background" class="w-full form-input-dnd" required>
                        <option value="">-- Loading Backgrounds... --</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="alignment" class="block mb-1">Alignment</label>
                    <select id="alignment" name="alignment" class="w-full form-input-dnd" required>
                        <option value="">-- Select Alignment --</option>
                        <option value="Lawful Good">Lawful Good</option>
                        <option value="Neutral Good">Neutral Good</option>
                        <option value="Chaotic Good">Chaotic Good</option>
                        <option value="Lawful Neutral">Lawful Neutral</option>
                        <option value="True Neutral">True Neutral</option>
                        <option value="Chaotic Neutral">Chaotic Neutral</option>
                        <option value="Lawful Evil">Lawful Evil</option>
                        <option value="Neutral Evil">Neutral Evil</option>
                        <option value="Chaotic Evil">Chaotic Evil</option>
                    </select>
                </div>
            </div>

            <!-- Ability Score Inputs -->
            <div class="hr-dnd"></div>
            <div>
                <h2 class="text-2xl font-bold mb-4 text-center">Ability Scores</h2>
                <p class="text-center text-sm mb-6 opacity-75">Enter scores manually or let the dice decide.</p>
                <div class="grid grid-cols-3 md:grid-cols-6 gap-4 text-center">
                    <div><label for="strength" class="text-xs mb-2 uppercase">STR</label><input type="number"
                            id="strength" name="strength" class="form-input-dnd text-center w-full font-bold" min="3"
                            max="20" required value="10"></div>
                    <div><label for="dexterity" class="text-xs mb-2 uppercase">DEX</label><input type="number"
                            id="dexterity" name="dexterity" class="form-input-dnd text-center w-full font-bold" min="3"
                            max="20" required value="10"></div>
                    <div><label for="constitution" class="text-xs mb-2 uppercase">CON</label><input type="number"
                            id="constitution" name="constitution" class="form-input-dnd text-center w-full font-bold"
                            min="3" max="20" required value="10"></div>
                    <div><label for="intelligence" class="text-xs mb-2 uppercase">INT</label><input type="number"
                            id="intelligence" name="intelligence" class="form-input-dnd text-center w-full font-bold"
                            min="3" max="20" required value="10"></div>
                    <div><label for="wisdom" class="text-xs mb-2 uppercase">WIS</label><input type="number" id="wisdom"
                            name="wisdom" class="form-input-dnd text-center w-full font-bold" min="3" max="20" required
                            value="10"></div>
                    <div><label for="charisma" class="text-xs mb-2 uppercase">CHA</label><input type="number"
                            id="charisma" name="charisma" class="form-input-dnd text-center w-full font-bold" min="3"
                            max="20" required value="10"></div>
                </div>
            </div>

            <!-- Skills and Equipment Section -->
            <div class="hr-dnd"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-xl font-bold mb-4 border-b border-[#5c4033] pb-1">Skills</h2>
                    <div id="skills-container" class="space-y-2 h-40 overflow-y-auto pr-2 custom-scrollbar">
                        <p class="text-sm italic opacity-50">Select a class to see available skills.</p>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold mb-4 border-b border-[#5c4033] pb-1">Starting Equipment</h2>
                    <div id="equipment-container" class="space-y-2 h-40 overflow-y-auto pr-2 custom-scrollbar">
                        <p class="text-sm italic opacity-50">Select a class to see equipment.</p>
                    </div>
                </div>
            </div>

            <!-- Turnstile widget -->
            <div id="turnstile-container" class="flex justify-center mb-4"></div>

            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row gap-4 mt-8 pt-4 border-t border-[#5c4033] border-opacity-25">
                <button type="button" id="btn-manual" class="btn-dnd btn-primary-dnd flex-1 text-center shadow-lg">Save
                    Manual Scores</button>
                <div class="flex items-center justify-center text-sm font-bold opacity-50 px-2">- OR -</div>
                <button type="button" id="btn-roll" class="btn-dnd btn-secondary-dnd flex-1 text-center shadow-lg">Roll
                    4d6 (Auto-Save)</button>
            </div>
        </form>
    </div>

    <script>
        async function apiFetch(endpoint, options = {}) {
            options.credentials = 'include';
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            return response;
        }

        document.addEventListener('DOMContentLoaded', async function () {
            // Check Auth
            const authRes = await apiFetch('/api/check-auth');
            const authData = await authRes.json();
            if (!authData.logged_in) {
                window.location.href = 'login.html';
                return;
            }

            // Populate Turnstile
            if (typeof TURNSTILE_SITE_KEY !== 'undefined' && TURNSTILE_SITE_KEY !== 'YOUR_TURNSTILE_SITE_KEY') {
                const container = document.getElementById('turnstile-container');
                const widget = document.createElement('div');
                widget.className = 'cf-turnstile';
                widget.setAttribute('data-sitekey', TURNSTILE_SITE_KEY);
                container.appendChild(widget);
            }

            // Populate Dropdowns
            const raceSelect = document.getElementById('race');
            const classSelect = document.getElementById('class');
            const backgroundSelect = document.getElementById('background');

            async function populate(endpoint, el, placeholder) {
                const res = await apiFetch(endpoint);
                const data = await res.json();
                el.innerHTML = `<option value="">${placeholder}</option>`;
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.name;
                    el.appendChild(opt);
                });
            }

            populate('/get-races', raceSelect, '-- Choose Race --');
            populate('/get-classes', classSelect, '-- Choose Class --');
            populate('/get-backgrounds', backgroundSelect, '-- Choose Background --');

            // Class details change
            classSelect.addEventListener('change', async function () {
                const id = this.value;
                if (!id) return;
                const res = await apiFetch(`/get-class-details/${id}`);
                const data = await res.json();

                const skillsEl = document.getElementById('skills-container');
                skillsEl.innerHTML = data.skills.length ? '' : '<p class="text-sm italic opacity-50">No skills available.</p>';
                data.skills.forEach(s => {
                    const div = document.createElement('div');
                    div.innerHTML = `<label class="inline-flex items-center cursor-pointer"><input type="checkbox" name="skills" value="${s.id}" class="form-checkbox bg-transparent border-[#5c4033] text-[#8b0000] focus:ring-[#d4af37] mr-2"><span>${s.name}</span></label>`;
                    skillsEl.appendChild(div);
                });

                const equipEl = document.getElementById('equipment-container');
                equipEl.innerHTML = data.equipment.length ? '' : '<p class="text-sm italic opacity-50">No equipment available.</p>';
                data.equipment.forEach(e => {
                    const div = document.createElement('div');
                    div.innerHTML = `<label class="inline-flex items-center cursor-pointer"><input type="checkbox" name="equipment" value="${e.id}" class="form-checkbox bg-transparent border-[#5c4033] text-[#8b0000] focus:ring-[#d4af37] mr-2"><span>${e.name}</span></label>`;
                    equipEl.appendChild(div);
                });
            });

            // Form submission
            async function submitForm(isRoll) {
                const form = document.getElementById('character-form');
                const formData = new FormData(form);
                if (isRoll) formData.append('roll_scores', 'true');

                const messageContainer = document.getElementById('message-container');
                messageContainer.innerHTML = '';

                try {
                    const res = await apiFetch('/create-character', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (res.ok) {
                        window.location.href = 'dashboard.html';
                    } else {
                        const alert = document.createElement('div');
                        alert.className = 'alert-dnd px-4 py-3 rounded relative mb-2 text-center shadow-md';
                        alert.textContent = data.error || 'Creation failed';
                        messageContainer.appendChild(alert);
                    }
                } catch (e) {
                    console.error(e);
                    alert('Network error');
                }
            }

            document.getElementById('btn-manual').addEventListener('click', () => submitForm(false));
            document.getElementById('btn-roll').addEventListener('click', () => submitForm(true));
        });
    </script>
</body>

</html>