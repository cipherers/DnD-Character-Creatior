<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add DND Info</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="static/css/dnd-theme.css">
    <link rel="icon" href="data:,">
    <script src="static/js/config.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>

<body class="flex items-center justify-center min-h-screen p-4 pt-24">
    <header class="absolute top-0 left-0 w-full p-4 z-50">
        <nav class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold" style="color: var(--accent-gold);">DnD Character Creator</h1>
            <ul class="flex gap-6">
                <li><a href="index.html" class="hover:text-white">Home</a></li>
                <li><a href="dashboard.html" class="hover:text-white">Dashboard</a></li>
                <li><a href="gamer_manual.html" class="hover:text-white">Manual</a></li>
            </ul>
        </nav>
    </header>

    <div class="parchment-box p-8 md:p-12 w-full max-w-4xl mt-8">
        <h1 class="text-3xl font-bold text-center mb-2">Tome of Knowledge</h1>
        <p class="text-center text-sm italic mb-8 text-[#5c4033] opacity-80">Expand the universe with new lore.</p>

        <form id="add-dnd-info-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="type" class="block mb-1">Entry Type</label>
                    <select id="type" name="type" class="w-full form-input-dnd" required>
                        <option value="">-- Select Type --</option>
                        <option value="race">Race</option>
                        <option value="class">Class</option>
                        <option value="ability">Ability</option>
                        <option value="equipment">Equipment</option>
                        <option value="background">Background</option>
                    </select>
                </div>
                <div>
                    <label for="name" class="block mb-1">Name</label>
                    <input type="text" id="name" name="name" class="w-full form-input-dnd" required autocomplete="name"
                        placeholder="Name of entry...">
                </div>
            </div>

            <div>
                <label for="description" class="block mb-1">Description</label>
                <textarea id="description" name="description" class="w-full form-input-dnd" rows="3" required
                    placeholder="Describe previous history and effects..."></textarea>
            </div>

            <div id="dynamic-fields-container" class="space-y-6 pt-4 border-t border-[#5c4033] border-opacity-30">
                <!-- Dynamic fields will be rendered here -->
            </div>

            <!-- Turnstile widget -->
            <div id="turnstile-container" class="flex justify-center mt-6"></div>

            <div class="mt-8 pt-4 flex gap-4">
                <button type="submit" class="btn-dnd btn-primary-dnd w-full shadow-lg">Inscribe into Tome</button>
            </div>
        </form>

        <div class="flex justify-center mt-6">
            <a href="index.html" class="btn-dnd btn-secondary-dnd text-xs">Return to Home</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Check Auth
            const authRes = await fetch(`${API_BASE_URL}/api/check-auth`, { credentials: 'include' });
            const authData = await authRes.json();
            if (!authData.logged_in) {
                // Redirect to login if not authorized for admin info
                window.location.href = 'login.html';
                return;
            }

            // Populate Turnstile
            if (typeof TURNSTILE_SITE_KEY !== 'undefined' && TURNSTILE_SITE_KEY !== 'YOUR_TURNSTILE_SITE_KEY') {
                const container = document.getElementById('turnstile-container');
                const widget = document.createElement('div');
                widget.className = 'cf-turnstile';
                widget.setAttribute('data-sitekey', TURNSTILE_SITE_KEY);
                container.appendChild(widget);
            }

            const form = document.getElementById('add-dnd-info-form');
            const typeSelect = document.getElementById('type');
            const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');

            const fieldTemplates = {
                race: `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div><label class="block text-xs mb-1">STR Bonus</label><input type="number" name="strength_bonus" class="form-input-dnd w-full text-center" value="0"></div>
                        <div><label class="block text-xs mb-1">DEX Bonus</label><input type="number" name="dexterity_bonus" class="form-input-dnd w-full text-center" value="0"></div>
                        <div><label class="block text-xs mb-1">CON Bonus</label><input type="number" name="constitution_bonus" class="form-input-dnd w-full text-center" value="0"></div>
                        <div><label class="block text-xs mb-1">INT Bonus</label><input type="number" name="intelligence_bonus" class="form-input-dnd w-full text-center" value="0"></div>
                        <div><label class="block text-xs mb-1">WIS Bonus</label><input type="number" name="wisdom_bonus" class="form-input-dnd w-full text-center" value="0"></div>
                        <div><label class="block text-xs mb-1">CHA Bonus</label><input type="number" name="charisma_bonus" class="form-input-dnd w-full text-center" value="0"></div>
                    </div>
                `,
                class: `
                    <div class="w-1/2">
                        <label class="block mb-1">Hit Die</label>
                        <input type="number" name="hit_die" class="form-input-dnd w-full" placeholder="e.g. 8" required>
                        <p class="text-xs mt-1 opacity-50">Just the number (e.g. 8 for 1d8)</p>
                    </div>
                `,
                background: `
                    <div class="text-sm italic opacity-70 border p-2 border-[#5c4033] rounded">
                        <p>Backgrounds primarily provide flavor text. No mechanical stats are required here.</p>
                    </div>
                `,
                ability: `
                    <div>
                        <label class="block mb-1">Associated Attribute</label>
                        <select name="associated_attribute" class="form-input-dnd w-full" required>
                            <option value="strength">Strength</option>
                            <option value="dexterity">Dexterity</option>
                            <option value="constitution">Constitution</option>
                            <option value="intelligence">Intelligence</option>
                            <option value="wisdom">Wisdom</option>
                            <option value="charisma">Charisma</option>
                        </select>
                    </div>
                `,
                equipment: `
                    <div>
                        <label class="block mb-1">Item Type</label>
                        <select name="item_type" class="form-input-dnd w-full" id="item-type-select" required>
                            <option value="Weapon">Weapon</option>
                            <option value="Armor">Armor</option>
                            <option value="Potion">Potion</option>
                            <option value="Adventuring Gear">Adventuring Gear</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div id="weapon-fields" class="space-y-4 hidden mt-4 pl-4 border-l-2 border-[#8b0000]">
                        <div><label class="block mb-1">Damage Dice</label><input type="text" name="damage_dice" class="form-input-dnd w-full" placeholder="e.g. 1d8"></div>
                        <div><label class="block mb-1">Damage Type</label><select name="damage_type" class="form-input-dnd w-full"><option value="Slashing">Slashing</option><option value="Piercing">Piercing</option><option value="Bludgeoning">Bludgeoning</option><option value="Fire">Fire</option><option value="Cold">Cold</option><option value="Force">Force</option><option value="Radiant">Radiant</option><option value="Necrotic">Necrotic</option></select></div>
                    </div>
                    <div id="armor-fields" class="space-y-4 hidden mt-4 pl-4 border-l-2 border-[#8b0000]">
                        <div><label class="block mb-1">Armor Class (AC) / Bonus</label><input type="number" name="ac" class="form-input-dnd w-full" min="0" placeholder="e.g. 14"></div>
                    </div>
                `
            };

            typeSelect.addEventListener('change', function () {
                const type = this.value;
                dynamicFieldsContainer.innerHTML = fieldTemplates[type] || '';
                if (type === 'equipment') {
                    const itemTypeSelect = document.getElementById('item-type-select');
                    const weaponFields = document.getElementById('weapon-fields');
                    const armorFields = document.getElementById('armor-fields');
                    itemTypeSelect.addEventListener('change', function () {
                        const val = this.value;
                        weaponFields.classList.toggle('hidden', val !== 'Weapon');
                        armorFields.classList.toggle('hidden', val !== 'Armor');
                    });
                    itemTypeSelect.dispatchEvent(new Event('change'));
                }
            });

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                const formData = new FormData(form);
                try {
                    const response = await fetch(`${API_BASE_URL}/add-dnd-info`, { method: 'POST', body: formData, credentials: 'include' });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || 'Successfully Inscribed!');
                        form.reset();
                        dynamicFieldsContainer.innerHTML = '';
                    } else {
                        alert(result.error || 'Failed to add');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error');
                }
            });
        });
    </script>
</body>

</html>