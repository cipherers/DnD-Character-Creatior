<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Up - {{ character.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dnd-theme.css') }}">
    <style>
        .step-active {
            color: var(--accent-red);
            transform: translateY(-2px);
        }

        .step-inactive {
            color: var(--border-brown);
            opacity: 0.6;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--bg-parchment);
            border: 2px solid var(--border-brown);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            margin-bottom: 0.75rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .step-active .step-circle {
            background-color: var(--accent-red);
            color: var(--accent-gold);
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(139, 0, 0, 0.3), inset 0 0 10px rgba(212, 175, 55, 0.2);
            transform: scale(1.15) rotate(5deg);
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4 pt-24">
    <div class="parchment-box p-8 md:p-12 w-full max-w-2xl min-h-[500px] flex flex-col">
        <h1 class="text-3xl font-bold mb-2 text-center">Level Up</h1>
        <p class="text-center italic mb-6 text-[#5c4033]">{{ character.name }} reaches Level {{ character.level + 1 }}!
        </p>

        <!-- Progress Steps -->
        <div class="relative mb-12">
            <!-- Background Line -->
            <div
                class="absolute top-1/2 left-0 w-full h-0.5 bg-gradient-to-r from-transparent via-[#5c4033] to-transparent opacity-30 -translate-y-1/2">
            </div>

            <div class="flex justify-between relative z-10">
                <!-- Step 1 -->
                <div id="step-indicator-1"
                    class="step-active flex flex-col items-center group cursor-pointer transition-all duration-300">
                    <div class="step-circle shadow-lg group-hover:border-[#d4af37]">1</div>
                    <span
                        class="text-[10px] sm:text-xs uppercase tracking-[0.2em] font-serif font-bold transition-colors">Vitality</span>
                </div>
                <!-- Step 2 -->
                <div id="step-indicator-2"
                    class="step-inactive flex flex-col items-center group cursor-pointer transition-all duration-300">
                    <div class="step-circle shadow-lg group-hover:border-[#d4af37]">2</div>
                    <span
                        class="text-[10px] sm:text-xs uppercase tracking-[0.2em] font-serif font-bold transition-colors">Features</span>
                </div>
                <!-- Step 3 -->
                <div id="step-indicator-3"
                    class="step-inactive flex flex-col items-center group cursor-pointer transition-all duration-300">
                    <div class="step-circle shadow-lg group-hover:border-[#d4af37]">3</div>
                    <span
                        class="text-[10px] sm:text-xs uppercase tracking-[0.2em] font-serif font-bold transition-colors">Magic</span>
                </div>
                <!-- Step 4 -->
                <div id="step-indicator-4"
                    class="step-inactive flex flex-col items-center group cursor-pointer transition-all duration-300">
                    <div class="step-circle shadow-lg group-hover:border-[#d4af37]">4</div>
                    <span
                        class="text-[10px] sm:text-xs uppercase tracking-[0.2em] font-serif font-bold transition-colors">Confirm</span>
                </div>
            </div>
        </div>

        <form id="level-up-form" class="flex-1 flex flex-col">
            <input type="hidden" name="character_id" value="{{ character.id }}">
            <input type="hidden" name="level" value="{{ character.level + 1 }}">

            <!-- Step 1: HP -->
            <div id="step-1" class="step-content flex-1">
                <h2 class="text-xl font-bold mb-4">Increase Hit Points</h2>
                <div class="bg-white bg-opacity-40 p-6 rounded border border-[#5c4033]">
                    <label class="block font-bold mb-2">New Maximum HP</label>
                    <div class="flex items-center gap-4">
                        <input type="number" name="hp"
                            value="{{ character.hp + (character.character_class.hit_die // 2 + 1) }}"
                            class="form-input-dnd text-2xl w-24 text-center font-bold text-[#8b0000]">
                        <span class="text-sm italic text-[#5c4033]">(Average: +{{ (character.character_class.hit_die //
                            2 + 1) }})</span>
                    </div>
                </div>
            </div>

            <!-- Step 2: Features (ASI / Feats) -->
            <div id="step-2" class="step-content hidden flex-1">
                <h2 class="text-xl font-bold mb-4">Class Features</h2>
                {% if (character.level + 1) % 4 == 0 %}
                <div class="bg-[#eaddcf] p-6 rounded border border-[#c2b280]">
                    <h3 class="font-bold text-[#8b0000] mb-2">Ability Score Improvement</h3>
                    <p class="text-sm mb-4">You have reached a milestone. Choose your reward.</p>

                    <select name="ability_modification" id="ability-mod-select"
                        class="form-input-dnd w-full mb-4 font-bold">
                        <option value="">-- Select Improvement --</option>
                        <option value="all_plus_one">+1 to All Abilities</option>
                        <option value="single_plus_two">+2 to One Ability</option>
                        <option value="feat">Learn a Feat</option>
                    </select>

                    <div id="single-ability-choice" class="hidden">
                        <label class="block text-sm font-bold mb-1">Select Ability</label>
                        <select name="selected_ability" class="form-input-dnd w-full">
                            <option value="strength">Strength</option>
                            <option value="dexterity">Dexterity</option>
                            <option value="constitution">Constitution</option>
                            <option value="intelligence">Intelligence</option>
                            <option value="wisdom">Wisdom</option>
                            <option value="charisma">Charisma</option>
                        </select>
                    </div>

                    <div id="feat-choice" class="hidden">
                        <label class="block text-sm font-bold mb-1">Select Feat</label>
                        <select name="feats" id="feat-select" class="form-input-dnd w-full mb-2">
                            <!-- Populated by JS -->
                        </select>
                        <p id="feat-desc"
                            class="text-sm italic p-2 border border-[#5c4033] rounded bg-white bg-opacity-50"></p>
                    </div>
                </div>
                {% else %}
                <div class="text-center p-8 opacity-60">
                    <p>No Ability Score Improvements at this level.</p>
                    <p class="text-sm">Your class abilities improve automatically.</p>
                </div>
                {% endif %}
            </div>

            <!-- Step 3: Spells -->
            <div id="step-3" class="step-content hidden flex-1">
                <h2 class="text-xl font-bold mb-4">Arcane Study</h2>
                <div class="h-64 overflow-y-auto custom-scrollbar border border-[#5c4033] p-2 bg-white bg-opacity-40"
                    id="spells-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Step 4: Review -->
            <div id="step-4" class="step-content hidden flex-1">
                <h2 class="text-xl font-bold mb-4">Confirm Ascension</h2>
                <div class="p-6 rounded border border-[#5c4033] bg-white bg-opacity-30">
                    <p class="text-lg"><strong>New Level:</strong> {{ character.level + 1 }}</p>
                    <p class="italic text-sm mt-2 opacity-70">"With great power comes great responsibility..."</p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between mt-8 pt-4 border-t border-[#5c4033] border-opacity-20">
                <button type="button" id="prev-btn" class="btn-dnd btn-secondary-dnd hidden">Back</button>
                <div class="flex gap-4 ml-auto">
                    <a href="/dashboard" class="btn-dnd btn-secondary-dnd opacity-50 hover:opacity-100">Cancel</a>
                    <button type="button" id="next-btn" class="btn-dnd btn-primary-dnd">Next</button>
                    <button type="submit" id="submit-btn" class="btn-dnd btn-primary-dnd hidden">Ascend!</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let currentStep = 1;
            const totalSteps = 4;
            const characterClass = "{{ character.character_class.name }}";
            const spellcastingClasses = ["Wizard", "Sorcerer", "Cleric", "Warlock", "Bard", "Druid", "Paladin", "Ranger"];
            const isSpellcaster = spellcastingClasses.some(c => characterClass.includes(c));

            // Fetch data
            const [featsRes, spellsRes] = await Promise.all([
                fetch('/get-feats'),
                fetch('/get-spells')
            ]);
            const feats = await featsRes.json();
            const spells = await spellsRes.json();

            // Populate Feats
            const featSelect = document.getElementById('feat-select');
            const featDesc = document.getElementById('feat-desc');
            if (featSelect) {
                feats.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = f.name;
                    featSelect.appendChild(opt);
                });
                featSelect.addEventListener('change', () => {
                    const feat = feats.find(f => f.id == featSelect.value);
                    featDesc.textContent = feat ? feat.description : 'Select a feat to view details...';
                });
                featSelect.dispatchEvent(new Event('change')); // Trigger initial desc
            }

            // Populate Spells
            if (isSpellcaster) {
                const spellsList = document.getElementById('spells-list');
                const fragment = document.createDocumentFragment();
                spells.forEach(s => {
                    const div = document.createElement('div');
                    div.className = "flex items-start gap-2 p-2 border-b border-[#5c4033] border-opacity-20 hover:bg-[#8b0000] hover:bg-opacity-5 transition-colors cursor-pointer";
                    div.innerHTML = `
                    <input type="checkbox" name="spells" value="${s.id}" id="spell-${s.id}" class="form-checkbox mt-1 text-[#8b0000] focus:ring-[#d4af37]">
                    <div class="flex-1">
                        <label for="spell-${s.id}" class="font-bold block text-[#8b0000] cursor-pointer">${s.name} <span class="text-xs text-[#5c4033] font-normal">(Lvl ${s.level})</span></label>
                        <p class="text-xs text-[#5c4033] italic">${s.description.substring(0, 60)}...</p>
                    </div>
                    `;
                    // Allow clicking the div to toggle
                    div.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const cb = div.querySelector('input');
                            cb.checked = !cb.checked;
                        }
                    });
                    fragment.appendChild(div);
                });
                spellsList.appendChild(fragment);
            } else {
                document.getElementById('step-indicator-3').style.display = 'none'; // Completely hide if not relevant? Or maybe strike through.
                // Actually logic handles skip.
            }

            // Step 2 Logic
            const abiSelect = document.getElementById('ability-mod-select');
            if (abiSelect) {
                abiSelect.addEventListener('change', () => {
                    document.getElementById('single-ability-choice').classList.toggle('hidden', abiSelect.value !== 'single_plus_two');
                    document.getElementById('feat-choice').classList.toggle('hidden', abiSelect.value !== 'feat');
                });
            }

            // Navigation
            const updateStep = () => {
                document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`step-${currentStep}`).classList.remove('hidden');

                document.getElementById('prev-btn').classList.toggle('hidden', currentStep === 1);
                document.getElementById('next-btn').classList.toggle('hidden', currentStep === totalSteps);
                document.getElementById('submit-btn').classList.toggle('hidden', currentStep !== totalSteps);

                // Update indicators
                for (let i = 1; i <= totalSteps; i++) {
                    const el = document.getElementById(`step-indicator-${i}`);
                    if (el) {
                        el.className = i === currentStep ? "step-active" : "step-inactive";
                    }
                }
            };

            document.getElementById('next-btn').addEventListener('click', () => {
                if (currentStep < totalSteps) {
                    currentStep++;
                    if (!isSpellcaster && currentStep === 3) currentStep++;
                    updateStep();
                }
            });

            document.getElementById('prev-btn').addEventListener('click', () => {
                if (currentStep > 1) {
                    currentStep--;
                    if (!isSpellcaster && currentStep === 3) currentStep--;
                    updateStep();
                }
            });

            document.getElementById('level-up-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                try {
                    const res = await fetch('/update-character', { method: 'POST', body: formData });
                    if (res.ok) {
                        alert("Ascension Complete!");
                        window.location.href = '/dashboard';
                    } else alert("Review your choices... something went wrong.");
                } catch (arr) { alert("The ley lines are blocked (Network Error)."); }
            });
        });
    </script>
</body>

</html>