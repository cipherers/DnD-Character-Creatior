<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Tailwind for Layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D&D Theme -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dnd-theme.css') }}">
</head>

<body class="flex items-center justify-center min-h-screen p-4 pt-24">
    <header class="absolute top-0 left-0 w-full p-4 z-50">
        <nav class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold" style="color: var(--accent-gold);">DnD Character Creator</h1>
            <ul class="flex gap-6">
                <li><a href="/index.html">Create</a></li>
                <li><a href="/add-dnd-info">Add Info</a></li>
                <li><a href="/gamer_manual.html">Manual</a></li>
                <li><a href="{{ url_for('logout') }}" class="text-red-400 hover:text-red-300">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="parchment-box p-6 md:p-10 w-full max-w-6xl mt-8 min-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-8 border-b border-[#5c4033] pb-4">
            <h1 class="text-4xl font-bold">Adventurer's Journal</h1>
            <a href="{{ url_for('create_character') }}" class="btn-dnd btn-secondary-dnd text-sm">Create New</a>
        </div>

        {% if characters and characters|length > 0 %}
        <div class="md:flex md:space-x-8 flex-1">
            <!-- Left: character list -->
            <div class="md:w-1/2 flex flex-col">
                <h2 class="text-xl font-bold mb-4">Roster</h2>
                <div class="overflow-y-auto max-h-[600px] pr-2 custom-scrollbar flex-1">
                    <ul class="space-y-4">
                        {% for char in characters %}
                        <li>
                            <div id="char-{{ char.id }}"
                                class="character-card stat-card-dnd p-4 flex items-center space-x-4 cursor-pointer hover:shadow-md transition-all border border-[#5c4033] bg-white relative"
                                data-char-id="{{ char.id }}" data-name="{{ char.name }}" data-level="{{ char.level }}"
                                data-age="{{ char.age }}"
                                data-class="{{ char.character_class.name if char.character_class else '' }}"
                                data-race="{{ char.race.name if char.race else '' }}"
                                data-background="{{ char.background.name if char.background else '' }}"
                                data-str="{{ char.strength }}" data-dex="{{ char.dexterity }}"
                                data-con="{{ char.constitution }}" data-int="{{ char.intelligence }}"
                                data-wis="{{ char.wisdom }}" data-cha="{{ char.charisma }}"
                                data-image="{{ char.image_path }}">

                                <!-- Portrait Thumbnail -->
                                <div
                                    class="w-16 h-16 rounded-full overflow-hidden border-2 border-[#d4af37] flex-shrink-0 bg-[#2c1810]">
                                    {% if char.image_path %}
                                    <img src="{{ char.image_path }}" alt="{{ char.name }}"
                                        class="w-full h-full object-cover">
                                    {% else %}
                                    <img src="https://api.dicebear.com/7.x/adventurer/svg?seed={{ char.name }}"
                                        alt="{{ char.name }}" class="w-full h-full object-cover opactiy-80">
                                    {% endif %}
                                </div>



                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold text-xl text-[#8b0000] font-serif">{{ char.name }}
                                            </div>
                                            <div class="text-sm font-serif text-[#5c4033]">{{ char.race.name }} {{
                                                char.character_class.name }}</div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Level {{ char.level }}</div>
                                </div>
                            </div>

                            <!-- Action Bar -->
                            <div class="mt-2 flex gap-2 pl-2">
                                <button class="btn-dnd btn-secondary-dnd text-xs py-1 px-3 edit-character-btn"
                                    data-id="{{ char.id }}">Edit</button>
                                <a href="{{ url_for('level_up_wizard', character_id=char.id) }}"
                                    class="btn-dnd btn-primary-dnd text-xs py-1 px-3">Level Up</a>
                                <a href="{{ url_for('download_character_pdf', character_id=char.id) }}"
                                    class="btn-dnd btn-secondary-dnd text-xs py-1 px-3" title="Export PDF">PDF</a>

                                <form method="post" action="{{ url_for('delete_character', char_id=char.id) }}"
                                    onsubmit="return confirm('Burn this character sheet?')" class="ml-auto">
                                    <button type="submit"
                                        class="text-red-900 opacity-60 hover:opacity-100 text-xs px-2 py-1 uppercase font-bold tracking-widest">Delete</button>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Right: persistent details panel -->
            <aside id="char-details-panel" class="md:w-1/2 parchment-box p-6 mt-6 md:mt-0 relative min-h-[400px]">
                <!-- Decorative corner accents just for this panel -->
                <div class="absolute top-0 right-0 p-2 opacity-20 pointer-events-none text-4xl">üêâ</div>

                <div id="char-details-empty" class="text-center text-[#5c4033] opacity-60 mt-20 italic">
                    Select a character to view their parchment.
                </div>

                <div id="char-details-content" class="hidden h-full flex flex-col">
                    <div class="flex items-center mb-6 border-b border-[#5c4033] pb-4">
                        <div class="character-thumb-dnd w-24 h-24 mr-6 rounded overflow-hidden">
                            <img id="detail-thumb" src="" alt="" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <div id="detail-name" class="font-bold text-3xl text-[#8b0000] font-serif"></div>
                            <div id="detail-sub" class="text-lg font-serif italic text-[#5c4033]"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <div class="text-xs uppercase tracking-widest text-[#5c4033] mb-1">Class</div>
                            <div id="detail-class" class="font-bold text-lg">-</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-widest text-[#5c4033] mb-1">Race</div>
                            <div id="detail-race" class="font-bold text-lg">-</div>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-widest text-[#5c4033] mb-1">Background</div>
                            <div id="detail-background" class="font-bold text-lg">-</div>
                        </div>
                    </div>

                    <div class="bg-[#eaddcf] p-4 rounded border border-[#c2b280] mb-4">
                        <div class="font-bold text-[#8b0000] mb-2 font-serif text-center">Ability Scores</div>
                        <div class="grid grid-cols-3 gap-y-4 gap-x-2 text-center">
                            <div>
                                <div class="text-xs">STR</div>
                                <div id="detail-str" class="text-xl font-bold"></div>
                            </div>
                            <div>
                                <div class="text-xs">DEX</div>
                                <div id="detail-dex" class="text-xl font-bold"></div>
                            </div>
                            <div>
                                <div class="text-xs">CON</div>
                                <div id="detail-con" class="text-xl font-bold"></div>
                            </div>
                            <div>
                                <div class="text-xs">INT</div>
                                <div id="detail-int" class="text-xl font-bold"></div>
                            </div>
                            <div>
                                <div class="text-xs">WIS</div>
                                <div id="detail-wis" class="text-xl font-bold"></div>
                            </div>
                            <div>
                                <div class="text-xs">CHA</div>
                                <div id="detail-cha" class="text-xl font-bold"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Pagination logic (simplified style) -->
        {% if total > per_page %}
        <div class="flex justify-center mt-6 space-x-2">
            {% for p in range(1, (total // per_page) + (1 if total % per_page else 0) + 1) %}
            <a href="?page={{ p }}"
                class="px-3 py-1 rounded border border-[#5c4033] {{ 'bg-[#8b0000] text-white' if p == page else 'bg-transparent text-[#5c4033]' }}">{{
                p }}</a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Currency & Inventory Logic (Per Character - rendered in modal or below?) 
             The original dashboard had a summary list. I'll condense it to simplify the UI to be cleaner.
             We will skip rendering the massive list of all characters' inventories at the bottom and instead 
             rely on the "Edit Character" modal or a dedicated view for that, or simple "Details" panel expansion.
             
             Actually, to preserve functionality without rewriting EVERYTHING, I will put the currency input
             inside the "Summary" section if it exists, or verify where it was.
             It was at the bottom: "Character Summary ... for character in characters".
             
             Let's keep the summary section but style it as "Detailed Ledgers".
        -->

        <div class="mt-12">
            <h2 class="text-2xl font-bold mb-4 border-b border-[#5c4033] pb-2">Full Ledgers (Inventory & Currency)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for character in characters %}
                <div class="parchment-box p-4 bg-white relative">
                    <h3 class="text-lg font-bold text-[#8b0000]">{{ character.name }}</h3>

                    <!-- Currency -->
                    <div class="mt-4 bg-[#f9f5eb] p-2 rounded border border-[#e5e7eb]">
                        <h4 class="text-xs font-bold uppercase mb-2 text-[#5c4033]">Coin Purse</h4>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="flex flex-col">
                                <label>GP</label>
                                <input type="number" class="currency-input form-input-dnd text-center"
                                    data-char-id="{{ character.id }}" data-currency-type="gold_pieces"
                                    value="{{ character.gold_pieces }}" min="0">
                            </div>
                            <div class="flex flex-col">
                                <label>SP</label>
                                <input type="number" class="currency-input form-input-dnd text-center"
                                    data-char-id="{{ character.id }}" data-currency-type="silver_pieces"
                                    value="{{ character.silver_pieces }}" min="0">
                            </div>
                            <div class="flex flex-col">
                                <label>CP</label>
                                <input type="number" class="currency-input form-input-dnd text-center"
                                    data-char-id="{{ character.id }}" data-currency-type="copper_pieces"
                                    value="{{ character.copper_pieces }}" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Inventory -->
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-bold uppercase text-[#5c4033]">Inventory</h4>
                            <button
                                class="text-[10px] uppercase font-bold text-green-700 hover:text-green-900 add-item-btn"
                                data-char-id="{{ character.id }}">+ Add</button>
                        </div>
                        <ul class="text-sm space-y-1">
                            {% for item in character.inventory %}
                            <li class="flex justify-between border-b border-gray-100 pb-1">
                                <span>{{ item.name }}</span>
                                <button class="text-red-400 hover:text-red-600 remove-item-btn"
                                    data-char-id="{{ character.id }}" data-item-id="{{ item.id }}">√ó</button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% else %}
        <div class="text-center py-20">
            <h2 class="text-2xl font-bold mb-4">Your journey begins here...</h2>
            <a href="{{ url_for('create_character') }}" class="btn-dnd btn-primary-dnd text-lg">Create First
                Character</a>
        </div>
        {% endif %}
    </div>

    <!-- Modals -->
    <!-- Edit Modal -->
    <div id="edit-character-modal"
        class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="absolute inset-0 bg-black bg-opacity-70 transition-opacity"></div>
        <div
            class="parchment-box p-8 w-full max-w-lg relative z-10 transform scale-95 transition-all duration-300 bg-[#f4e4bc]">
            <h2 class="text-2xl font-bold mb-6 text-center border-b-2 border-[#8b0000] pb-2">Modify Attributes</h2>
            <form id="edit-character-form" class="space-y-4">
                <input type="hidden" id="edit-character-id" name="character_id">

                <input type="hidden" id="edit-character-level" name="level">

                <div class="h-max-40 overflow-auto border border-[#5c4033] p-2 bg-white bg-opacity-50">
                    <label class="block font-bold mb-2">Skills</label>
                    <div id="edit-character-skills" class="space-y-2"></div>
                </div>


                <div class="border-t border-[#5c4033] pt-4 mt-4">
                    <label class="block font-bold mb-2 text-[#8b0000]">Update Portrait</label>
                    <div class="flex items-center gap-4 bg-[#eaddcf] p-2 rounded border border-[#c2b280]">
                        <div class="w-12 h-12 rounded border border-[#5c4033] overflow-hidden bg-white flex-shrink-0">
                            <img id="edit-portrait-preview" src="" alt="" class="w-full h-full object-cover hidden">
                            <div id="edit-portrait-placeholder"
                                class="w-full h-full flex items-center justify-center text-[10px] text-gray-400">No
                                Image</div>
                        </div>
                        <input type="file" id="portrait-upload" accept="image/*"
                            class="text-xs flex-1 text-[#5c4033] file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-[#8b0000] file:text-[#d4af37] hover:file:bg-[#600000]">
                        <button type="button" id="upload-btn"
                            class="btn-dnd btn-primary-dnd text-xs py-1 px-3 shadow-sm hover:shadow-md transition-shadow">Upload</button>
                    </div>
                    <p id="upload-status" class="text-xs mt-1 text-center italic text-[#5c4033]"></p>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="btn-dnd btn-primary-dnd flex-1">Save</button>
                    <button type="button" id="close-edit-modal" class="btn-dnd btn-secondary-dnd flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="add-item-modal"
        class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="absolute inset-0 bg-black bg-opacity-70"></div>
        <div
            class="parchment-box p-6 w-full max-w-md relative z-10 transform scale-95 transition-all duration-300 bg-[#f4e4bc]">
            <h2 class="text-xl font-bold mb-4">Acquire Equipment</h2>
            <input type="hidden" id="add-item-char-id">
            <input type="text" id="item-search" placeholder="Search the armory..." class="form-input-dnd w-full mb-4">

            <div id="item-list-container"
                class="h-60 overflow-y-auto border border-[#5c4033] p-2 bg-white bg-opacity-50 space-y-2">
                <p class="text-center italic opacity-50">Consulting the quartermaster...</p>
            </div>

            <div class="mt-4 text-right">
                <button type="button" id="close-add-item-modal" class="btn-dnd btn-secondary-dnd">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts (Logic Preserved) -->
    <script>
        // Copying the script logic from previous file but adapting purely if classes changed.
        // Selector logic needs validation.
        // The previous script used .character-card for listeners. We kept that class.
        // It used IDs like edit-character-modal. We kept that.
        // It used .edit-character-btn. We kept that.

        // I will re-paste the script block to ensure it is present in the new file.
        // Just minifying/compacting slightly for brevity in this output, but logic remains same.

        document.addEventListener('DOMContentLoaded', function () {
            const panel = document.getElementById('char-details-panel');
            const empty = document.getElementById('char-details-empty');
            const content = document.getElementById('char-details-content');

            function showDetailsFromCard(card) {
                const name = card.dataset.name || '';
                const level = card.dataset.level || '';
                const age = card.dataset.age || '';
                const cls = card.dataset.class || '';
                const race = card.dataset.race || '';
                const str = card.dataset.str || '-';
                const dex = card.dataset.dex || '-';
                const con = card.dataset.con || '-';
                const intl = card.dataset.int || '-';
                const wis = card.dataset.wis || '-';
                const cha = card.dataset.cha || '-';
                const background = card.dataset.background || '';

                document.getElementById('detail-name').textContent = name;
                document.getElementById('detail-sub').textContent = `Level ${level} ‚Ä¢ Age ${age}`;
                document.getElementById('detail-class').textContent = cls || 'N/A';
                document.getElementById('detail-race').textContent = race || 'N/A';
                document.getElementById('detail-background').textContent = background || 'N/A';
                document.getElementById('detail-str').textContent = str;
                document.getElementById('detail-dex').textContent = dex;
                document.getElementById('detail-con').textContent = con;
                document.getElementById('detail-int').textContent = intl;
                document.getElementById('detail-wis').textContent = wis;
                document.getElementById('detail-cha').textContent = cha;

                const thumb = document.getElementById('detail-thumb');
                const imgPath = card.dataset.image;
                if (imgPath && imgPath !== 'None') {
                    thumb.src = '/' + imgPath;
                } else {
                    thumb.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(name)}`;
                }

                empty.classList.add('hidden');
                content.classList.remove('hidden');
            }

            document.querySelectorAll('.character-card').forEach(card => {
                card.addEventListener('mouseenter', () => showDetailsFromCard(card));
                card.addEventListener('click', (e) => { showDetailsFromCard(card); e.stopPropagation(); });
            });

            document.addEventListener('click', function () {
                if (window.innerWidth < 768) { // Mobile clear
                    empty.classList.remove('hidden');
                    content.classList.add('hidden');
                }
            });
        });

        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('div[class*="transform"]');
            if (show) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Edit Modal Logic
            const modalId = 'edit-character-modal';
            const form = document.getElementById('edit-character-form');
            const closeModal = document.getElementById('close-edit-modal');

            document.querySelectorAll('.edit-character-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const characterId = button.dataset.id;
                    const response = await fetch(`/get-character/${characterId}`);
                    if (!response.ok) return;
                    const character = await response.json();

                    /* 
                    if (character.level < 4 || character.level % 4 !== 0) {
                        alert("Character must be at an Ability Score Improvement level (4, 8, 12...) to use this specific Edit wizard. Use Level Up instead for general progression.");
                        return;
                    } 
                    */

                    document.getElementById('edit-character-id').value = character.id;
                    document.getElementById('edit-character-level').value = character.level;


                    const preview = document.getElementById('edit-portrait-preview');
                    const placeholder = document.getElementById('edit-portrait-placeholder');
                    if (character.image_path) {
                        preview.src = '/' + character.image_path;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    } else {
                        preview.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    }

                    const skillsContainer = document.getElementById('edit-character-skills');
                    skillsContainer.innerHTML = '';
                    character.available_skills.forEach(skill => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'skills';
                        checkbox.value = skill.id;
                        checkbox.checked = character.skills.includes(skill.id);
                        checkbox.className = 'form-checkbox mr-2'; // using theme class
                        const label = document.createElement('label');
                        label.textContent = skill.name;
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        skillsContainer.appendChild(div);
                    });
                    toggleModal(modalId, true);
                });
            });

            closeModal.addEventListener('click', () => toggleModal(modalId, false));


            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                try {
                    const res = await fetch('/update-character', { method: 'POST', body: formData });
                    if (res.ok) location.reload();
                    else alert('Failed to update');
                } catch (err) { alert(err.message); }
            });

            // Upload Logic
            const uploadBtn = document.getElementById('upload-btn');
            const uploadInput = document.getElementById('portrait-upload');
            const uploadStatus = document.getElementById('upload-status');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', async () => {
                    const file = uploadInput.files[0];
                    const charId = document.getElementById('edit-character-id').value;
                    if (!file || !charId) { uploadStatus.textContent = "Select file first."; return; }
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('character_id', charId);
                    try {
                        const res = await fetch('/upload-portrait', { method: 'POST', body: formData });
                        if (res.ok) uploadStatus.textContent = "Uploaded!";
                        else uploadStatus.textContent = "Failed.";
                    } catch (e) { uploadStatus.textContent = "Error."; }
                });
            }
        });

        // Inventory & Currency Logic (Debounced)
        document.addEventListener('DOMContentLoaded', function () {
            function debounce(func, wait) {
                let timeout;
                return function (...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
            }

            async function updateCurrency(input) {
                const charId = input.dataset.charId;
                const type = input.dataset.currencyType;
                const val = input.value;
                try {
                    await fetch('/update-character-currency', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ character_id: charId, currency_type: type, value: parseInt(val) })
                    });
                } catch (e) { console.error(e); }
            }
            const debouncedUpdate = debounce(updateCurrency, 500);
            document.querySelectorAll('.currency-input').forEach(i => i.addEventListener('change', () => debouncedUpdate(i)));

            // Add Item Logic
            const addItemModalId = 'add-item-modal';
            const closeAdd = document.getElementById('close-add-item-modal');
            const listContainer = document.getElementById('item-list-container');
            const search = document.getElementById('item-search');
            let allItems = [];

            document.querySelectorAll('.add-item-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const charId = btn.dataset.charId;
                    document.getElementById('add-item-char-id').value = charId;
                    toggleModal(addItemModalId, true);
                    if (allItems.length === 0) {
                        try {
                            const res = await fetch('/get-all-equipment');
                            allItems = await res.json();
                            renderItems(allItems);
                        } catch (e) { }
                    } else renderItems(allItems);
                });
            });

            closeAdd.addEventListener('click', () => toggleModal(addItemModalId, false));

            if (search) {
                search.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    renderItems(allItems.filter(i => i.name.toLowerCase().includes(term)));
                });
            }

            function renderItems(items) {
                listContainer.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 hover:bg-black hover:bg-opacity-5 cursor-pointer border-b border-[#5c4033] border-opacity-20';
                    div.innerHTML = `<span class="font-serif">${item.name} <em class="text-xs opacity-50">(${item.item_type})</em></span> <button class="text-xs font-bold text-green-800">ADD</button>`;
                    div.addEventListener('click', async () => {
                        const charId = document.getElementById('add-item-char-id').value;
                        await fetch('/add-inventory-item', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ character_id: charId, item_id: item.id })
                        });
                        location.reload();
                    });
                    listContainer.appendChild(div);
                });
            }

            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (confirm("Remove item?")) {
                        await fetch('/remove-inventory-item', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ character_id: btn.dataset.charId, item_id: btn.dataset.itemId })
                        });
                        location.reload();
                    }
                });
            });
        });
    </script>
</body>

</html>